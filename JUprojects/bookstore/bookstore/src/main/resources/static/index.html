<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <title>书店管理系统</title>
    <style>
        body {
            max-width: 900px;
            margin: 40px auto;
            font-family: Arial, sans-serif;
        }
        h1 {
            text-align: center;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 30px;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 8px 12px;
            text-align: left;
        }
        th {
            background-color: #f0f0f0;
        }
        form > div {
            margin-bottom: 12px;
        }
        label {
            display: inline-block;
            width: 80px;
        }
        input[type="text"], input[type="number"] {
            width: calc(100% - 100px);
            padding: 6px;
        }
        button {
            padding: 6px 12px;
            cursor: pointer;
            margin-right: 5px;
        }
        #message {
            margin-bottom: 15px;
            font-weight: bold;
            color: green;
        }
        .btn-edit {
            background-color: #4CAF50;
            color: white;
            border: none;
        }
        .btn-delete {
            background-color: #f44336;
            color: white;
            border: none;
        }
        .btn-cancel {
            background-color: #999;
            color: white;
            border: none;
        }
    </style>
</head>
<body>

<h1>书店管理系统</h1>

<div id="message"></div>

<table id="booksTable">
    <thead>
    <tr><th>ID</th><th>书名</th><th>作者</th><th>价格</th><th>库存</th><th>分类</th><th>操作</th></tr>
    </thead>
    <tbody></tbody>
</table>

<h2 id="formTitle">添加新书籍</h2>
<form id="bookForm">
    <input type="hidden" id="bookId" />
    <div>
        <label for="title">书名</label>
        <input type="text" id="title" name="title" required />
    </div>
    <div>
        <label for="author">作者</label>
        <input type="text" id="author" name="author" required />
    </div>
    <div>
        <label for="price">价格</label>
        <input type="number" id="price" name="price" step="0.01" min="0" required />
    </div>
    <div>
        <label for="stock">库存</label>
        <input type="number" id="stock" name="stock" min="0" required />
    </div>
    <div>
        <label for="category">分类</label>
        <input type="text" id="category" name="category" />
    </div>
    <button type="submit" id="submitBtn">添加书籍</button>
    <button type="button" id="cancelBtn" class="btn-cancel" style="display:none;">取消编辑</button>
</form>

<script>
    const API_BASE = '/api/books';

    const form = document.getElementById('bookForm');
    const messageDiv = document.getElementById('message');
    const formTitle = document.getElementById('formTitle');
    const submitBtn = document.getElementById('submitBtn');
    const cancelBtn = document.getElementById('cancelBtn');

    // 加载书籍列表
    function loadBooks() {
        fetch(API_BASE)
            .then(res => {
                if (!res.ok) throw new Error('加载失败: ' + res.status);
                return res.json();
            })
            .then(books => {
                const tbody = document.querySelector('#booksTable tbody');
                tbody.innerHTML = '';
                books.forEach(book => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${book.id}</td>
                        <td>${book.title}</td>
                        <td>${book.author}</td>
                        <td>${book.price.toFixed(2)}</td>
                        <td>${book.stock}</td>
                        <td>${book.category || ''}</td>
                        <td>
                            <button class="btn-edit" onclick="editBook(${book.id})">编辑</button>
                            <button class="btn-delete" onclick="deleteBook(${book.id})">删除</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            })
            .catch(err => showMessage('错误: ' + err.message, true));
    }

    // 显示消息
    function showMessage(msg, isError = false) {
        messageDiv.textContent = msg;
        messageDiv.style.color = isError ? 'red' : 'green';
        if (!isError) {
            setTimeout(() => { messageDiv.textContent = ''; }, 3000);
        }
    }

    // 清空表单
    function clearForm() {
        form.bookId.value = '';
        form.reset();
        formTitle.textContent = '添加新书籍';
        submitBtn.textContent = '添加书籍';
        cancelBtn.style.display = 'none';
    }

    // 填充表单用于编辑
    function editBook(id) {
        fetch(`${API_BASE}/${id}`)
            .then(res => {
                if (!res.ok) throw new Error('获取书籍失败: ' + res.status);
                return res.json();
            })
            .then(book => {
                form.bookId.value = book.id;
                form.title.value = book.title;
                form.author.value = book.author;
                form.price.value = book.price;
                form.stock.value = book.stock;
                form.category.value = book.category || '';
                formTitle.textContent = `编辑书籍（ID: ${book.id}）`;
                submitBtn.textContent = '更新书籍';
                cancelBtn.style.display = 'inline-block';
            })
            .catch(err => showMessage(err.message, true));
    }

    // 删除书籍
    function deleteBook(id) {
        if (!confirm(`确定删除ID为 ${id} 的书籍吗？`)) return;
        fetch(`${API_BASE}/${id}`, {
            method: 'DELETE'
        })
            .then(res => {
                if (!res.ok) throw new Error('删除失败: ' + res.status);
                showMessage(`书籍ID ${id} 删除成功！`);
                loadBooks();
                if (form.bookId.value == id) {
                    clearForm();
                }
            })
            .catch(err => showMessage(err.message, true));
    }

    // 表单提交处理（新增或更新）
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const bookId = form.bookId.value.trim();
        const bookData = {
            title: form.title.value.trim(),
            author: form.author.value.trim(),
            price: parseFloat(form.price.value),
            stock: parseInt(form.stock.value, 10),
            category: form.category.value.trim()
        };

        if (bookId) {
            // 更新
            fetch(`${API_BASE}/${bookId}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(bookData)
            })
                .then(res => {
                    if (!res.ok) throw new Error('更新失败: ' + res.status);
                    return res.json();
                })
                .then(data => {
                    showMessage(`书籍ID ${data.id} 更新成功！`);
                    clearForm();
                    loadBooks();
                })
                .catch(err => showMessage(err.message, true));
        } else {
            // 新增
            fetch(API_BASE, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(bookData)
            })
                .then(res => {
                    if (!res.ok) throw new Error('添加失败: ' + res.status);
                    return res.json();
                })
                .then(data => {
                    showMessage(`书籍 "${data.title}" 添加成功！`);
                    clearForm();
                    loadBooks();
                })
                .catch(err => showMessage(err.message, true));
        }
    });

    // 取消编辑按钮
    cancelBtn.addEventListener('click', () => {
        clearForm();
    });

    window.onload = loadBooks;
</script>

</body>
</html>
